// ==============================================================
// Ad-Arch Group OS — Prisma スキーマ
// Phase 2: コアモジュール（Branch / User / Customer / Deal）
//
// 【マルチテナント設計の原則】
//   - 全業務データは必ず Branch（拠点）に紐づく
//   - ADMIN（本部）: branchId = null → 全拠点データにアクセス可
//   - MANAGER/USER : branchId あり → 自拠点データのみアクセス可
//   - クエリ側で WHERE branchId = user.branchId を付与してスコープを絞る
// ==============================================================

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==============================================================
// Enums
// ==============================================================

enum Role {
  ADMIN   // 本部: 全拠点・全データ フルアクセス
  MANAGER // 代表: 自拠点の財務・売上・全実務ツール
  USER    // 一般社員: 実務ツールのみ / 財務データアクセス不可
}

enum DealStatus {
  PROSPECTING // 見込み
  QUALIFYING  // 検討中
  PROPOSAL    // 提案中
  NEGOTIATION // 交渉中
  CLOSED_WON  // 受注
  CLOSED_LOST // 失注
}

enum ActivityType {
  CALL    // 電話
  EMAIL   // メール
  VISIT   // 訪問
  MEETING // Web会議
  OTHER   // その他
  SYSTEM  // システム自動ログ（顧客情報変更など）
}

enum CustomerRank {
  A // 重要
  B // 通常
  C // 見込み
  D // 以後取引回避
}

enum CustomerStatus {
  PROSPECT // 見込み
  ACTIVE   // 取引中
  INACTIVE // 休眠
  BLOCKED  // 取引回避
}

enum ProjectStatus {
  ORDERED      // 受注済み
  IN_PROGRESS  // 進行中
  COMPLETED    // 完了
  ON_HOLD      // 保留
  CANCELLED    // キャンセル
}

enum ExpenseCategory {
  LABOR        // 人件費
  MATERIAL     // 材料費
  SUBCONTRACT  // 外注費
  TRANSPORT    // 交通・運送費
  COMMUNICATION // 通信費
  OTHER        // その他
}

enum ProjectLogType {
  SYSTEM          // システム自動ログ（フィールド変更）
  NOTE            // 手動メモ
  EXPENSE_ADDED   // 経費追加
  EXPENSE_DELETED // 経費削除
}

enum BillingStatus {
  UNBILLED // 未請求
  BILLED   // 請求済み
  PAID     // 入金済み
}

enum InvoiceRequestStatus {
  DRAFT     // 未提出
  SUBMITTED // 提出済
}

enum EstimationStatus {
  DRAFT    // 下書き（未発行・通知なし）
  ISSUED   // 発行済み（通知送信済み）
  SENT     // 送付済み（顧客に送付）
  ACCEPTED // 承認済み
  REJECTED // 却下
}

enum CollaborationRequestType {
  SHOOTING_SUPPORT   // 撮影支援
  EDITING_RESOURCE   // 編集リソース協力
  EQUIPMENT_CAST     // 機材・キャスト手配
  KNOWLEDGE_SHARING  // 知見共有・相談
  PROXY_VISIT        // クライアント別拠点の代理視察及び営業
  OTHER              // その他
}

enum CollaborationStatus {
  PENDING    // 未対応
  REVIEWING  // 検討中
  ACCEPTED   // 受諾
  DECLINED   // 辞退
  COMPLETED  // 完了
}

enum MediaType {
  TVER            // TVer
  CINE_AD         // シネアド（イオンシネマ）
  DIGITAL_SIGNAGE // デジタルサイネージ
  TAXI            // タクシー広告
  APA_HOTEL       // アパホテル
  UNIVERSITY      // 大学広告
  SKYLARK         // すかいらーく広告
  GOLF_CART       // ゴルフカート
  ACQUISITION     // 取得依頼
  OTHER           // その他
}

enum MediaRequestStatus {
  PENDING    // 依頼中
  REVIEWING  // 確認中
  COMPLETED  // 完了
  CANCELLED  // キャンセル
}

enum AdvertiserReviewStatus {
  PENDING   // 審査中（デフォルト）
  APPROVED  // 承認
  REJECTED  // 否決
}

enum TverCampaignBudgetType {
  TOTAL   // 期間予算
  MONTHLY // 月次予算（毎月1日更新）
}

enum TverFrequencyCapUnit {
  LIFETIME // 全期間
  WEEKLY   // 1週間
  DAILY    // 1日
  HOURLY   // 1時間
}

enum TverCompanionMobile {
  NONE        // 利用しない
  BANNER      // バナー
  ICON_TEXT   // アイコン/テキスト
  TEXT        // テキスト
}

enum TverCompanionPc {
  NONE    // 利用しない
  BANNER  // バナー
}

enum TverCampaignStatus {
  DRAFT     // 下書き
  SUBMITTED // 申請済み
  APPROVED  // 承認
  REJECTED  // 否決
}

// ==============================================================
// Branch（拠点）
// ==============================================================

/// Ad-Arch グループの各加盟拠点を表すマスタテーブル。
/// 全業務データはこの Branch に紐づくことで、
/// テナント（拠点）ごとにデータが分離される。
model Branch {
  id       String  @id @default(cuid())
  name     String  // 拠点名（例: 東京支社、大阪支店）
  code     String  @unique // 拠点コード・英数字（例: TKY, OSK）
  address  String? // 住所
  isActive Boolean @default(true) // 無効化フラグ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                      User[]
  customers                  Customer[]
  deals                      Deal[]
  projects                   Project[]
  expenses                   Expense[]
  wikiArticles               WikiArticle[]
  revenueReports             RevenueReport[]
  invoiceRequests            InvoiceRequest[]
  estimations                Estimation[]
  collaborationRequests      GroupCollaborationRequest[]
  mediaRequests              MediaRequest[]
  advertiserReviews          AdvertiserReview[]
  tverCampaigns              TverCampaign[]
  tverCreativeReviews        TverCreativeReview[]

  @@map("branches")
}

// ==============================================================
// User（ユーザー）
// ==============================================================

/// システムの利用者。Google Workspace SSO でログインする。
/// 本部（ADMIN）が role と branchId を手動で割り当てる。
///
/// 【branchId の意味】
///   null  → ADMIN（本部）→ 全拠点データにアクセス可能
///   値あり → MANAGER / USER → その拠点のデータのみアクセス可能
model User {
  id    String  @id @default(cuid())
  email String  @unique // Google Workspace のメールアドレス
  name  String? // 表示名
  image String? // プロフィール画像 URL

  role     Role    @default(MANAGER)
  // ■ branchId = null → 本部（ADMIN）→ WHERE 句なしで全拠点アクセス
  // ■ branchId あり   → 拠点スコープ → WHERE branchId = user.branchId
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  isActive Boolean @default(true) // 本部がアカウントを有効/無効管理

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedDeals               Deal[]                     @relation("AssignedTo")
  createdDeals                Deal[]                     @relation("CreatedBy")
  lockedCustomers             Customer[]                 @relation("LockedBy") // 先着ロック中の顧客
  revenueReports              RevenueReport[]
  invoiceRequests             InvoiceRequest[]
  collaborationRequests       GroupCollaborationRequest[]
  mediaRequests               MediaRequest[]
  createdAdvertiserReviews    AdvertiserReview[]         @relation("CreatedAdvertiserReview")
  reviewedAdvertiserReviews   AdvertiserReview[]         @relation("ReviewedAdvertiserReview")
  tverCampaigns               TverCampaign[]
  tverCreativeReviews         TverCreativeReview[]

  @@index([branchId])
  @@index([role])
  @@map("users")
}

// ==============================================================
// Customer（顧客）
// ==============================================================

/// 顧客（企業）情報を管理する CRM テーブル。
/// 必ず Branch に紐づき、拠点をまたいだ参照は ADMIN のみ可能。
///
/// 【先着優先ロック機能】
///   営業担当が「担当する」ボタンを押すと lockedBy に記録され、
///   他の営業は lockExpiresAt まで同一顧客への新規商談作成を制限される。
model Customer {
  id              String         @id @default(cuid())
  recordNumber    Int            @default(autoincrement()) @unique // kintone 互換の通し番号
  name            String         // 顧客名（法人名）
  nameKana        String?        // ふりがな（検索用）
  corporateNumber String?        @db.VarChar(13) // 法人番号（13桁）
  contactName     String?        // 担当者名
  email           String?        // 担当者メールアドレス
  phone           String?        // 電話番号
  website         String?        // 公式サイト URL
  industry        String?        // 業種
  source          String?        // 流入経路
  rank            CustomerRank   @default(B) // 顧客ランク A〜D
  status          CustomerStatus @default(PROSPECT) // 取引ステータス
  postalCode      String?        @db.VarChar(8) // 郵便番号（例: 100-0001）
  prefecture      String?        // 都道府県
  address         String?        // 住所（番地）
  building        String?        // ビル名・部屋番号
  notes           String?        @db.Text // 備考・メモ
  staffName       String?        // 社内担当者名（登録者）

  // ---- 先着優先ロック -------------------------------------------
  // ロック中は他の営業担当者が新規商談を作成できない
  lockedByUserId String?
  lockedBy       User?     @relation("LockedBy", fields: [lockedByUserId], references: [id])
  lockedAt       DateTime? // ロック開始日時
  lockExpiresAt  DateTime? // ロック期限（デフォルト: ロックから30分後）

  // ---- マルチテナント（必須）------------------------------------
  // 全顧客データは必ず拠点に紐づく。branchId なしでは登録不可。
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deals           Deal[]
  activityLogs    ActivityLog[]
  projects        Project[]
  invoiceRequests InvoiceRequest[]
  estimations     Estimation[]
  mediaRequests   MediaRequest[]

  @@index([branchId])
  @@index([lockedByUserId])
  @@index([name]) // 顧客名検索
  @@map("customers")
}

// ==============================================================
// ActivityLog（活動履歴）
// ==============================================================

/// 営業活動の記録。電話・メール・訪問・Web会議などを時系列で管理する。
model ActivityLog {
  id         String       @id @default(cuid())
  type       ActivityType @default(OTHER)
  content    String       @db.Text // 活動内容
  staffName  String                // 記録者名（ログイン名から自動取得）

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([customerId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ==============================================================
// Deal（商談）
// ==============================================================

/// 商談（案件）情報を管理する SFA テーブル。
/// Customer と Branch の両方に紐づく。
///
/// 【branchId の非正規化について】
///   Customer.branchId と同値を持つが、あえてここにも持たせる。
///   理由: 拠点フィルタリングのクエリを Customer JOIN なしで実行できるようにするため。
model Deal {
  id                String     @id @default(cuid())
  title             String     // 商談タイトル（例: ○○ビル 外壁改修工事）
  amount            Decimal?   @db.Decimal(15, 0) // 見積金額（円）
  status            DealStatus @default(PROSPECTING)
  probability       Int?       // 受注確度 0〜100（%）
  expectedCloseDate DateTime?  // 受注予定日
  closedAt          DateTime?  // 実際の受注/失注日
  notes             String?    @db.Text // 商談メモ・経緯

  // ---- 担当者 --------------------------------------------------
  assignedToId String? // 主担当営業
  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id])

  createdById String? // 商談作成者
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])

  // ---- 顧客との紐づき ------------------------------------------
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // ---- マルチテナント（必須・非正規化）--------------------------
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  dealLogs  DealLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId])
  @@index([assignedToId])
  @@index([customerId])
  @@index([status])
  @@index([expectedCloseDate])
  @@map("deals")
}

// ==============================================================
// DealLog（商談活動ログ）
// ==============================================================

/// 商談単位の活動ログ。
/// ActivityLog が Customer 紐づきであるのに対し、こちらは Deal 紐づき。
model DealLog {
  id        String       @id @default(cuid())
  type      ActivityType @default(OTHER)
  content   String       @db.Text
  staffName String

  dealId String
  deal   Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([dealId])
  @@index([createdAt])
  @@map("deal_logs")
}

// ==============================================================
// Project（プロジェクト）
// ==============================================================

/// 受注後の案件進行を管理するプロジェクト管理テーブル。
/// 商談（Deal）から受注に至った後、実務進行フェーズを管理する。
/// Customer（顧客）と Branch（拠点）の両方に紐づく。
model Project {
  id          String        @id @default(cuid())
  title       String        // プロジェクト名
  status      ProjectStatus @default(IN_PROGRESS)
  deadline    DateTime?     // 納期
  budget      Decimal?      @db.Decimal(15, 0) // 予算（円）
  description String?       @db.Text // 概要・説明
  staffName   String?       // 担当者名（登録者）

  // ---- 顧客との紐づき（任意: 顧客未確定のプロジェクトも可）----------
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // ---- マルチテナント（必須）----------------------------------------
  branchId    String
  branch      Branch    @relation(fields: [branchId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  billingStatus BillingStatus @default(UNBILLED) // 請求ステータス

  // Relations
  expenses               Expense[]
  logs                   ProjectLog[]
  invoiceRequests        InvoiceRequest[]
  estimations            Estimation[]
  collaborationRequests  GroupCollaborationRequest[]

  @@index([branchId])
  @@index([customerId])
  @@index([status])
  @@index([deadline])
  // 複合インデックス: 拠点別 + 最新順（一覧取得の主要クエリ）
  @@index([branchId, createdAt(sort: Desc)])
  // 複合インデックス: 拠点別 + ステータス絞り込み
  @@index([branchId, status])
  @@map("projects")
}

// ==============================================================
// Expense（経費）
// ==============================================================

/// プロジェクトに紐づく経費記録。
/// 予算と経費の差分から利益を自動計算する。
model Expense {
  id        String          @id @default(cuid())
  title     String          // 経費名・内容
  amount    Decimal         @db.Decimal(15, 0) // 金額（円）
  category  ExpenseCategory @default(OTHER)
  date      DateTime        @default(now()) // 発生日
  notes     String?         @db.Text // 備考
  staffName String?         // 記録者

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  branchId  String
  branch    Branch  @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([branchId])
  @@index([date])
  @@map("expenses")
}

// ==============================================================
// ProjectLog（プロジェクトログ）
// ==============================================================

/// プロジェクトの変更履歴・メモ。
/// SYSTEM: フィールド変更の自動ログ
/// NOTE: 手動メモ
/// EXPENSE_ADDED/DELETED: 経費の追加・削除ログ
model ProjectLog {
  id        String         @id @default(cuid())
  type      ProjectLogType @default(NOTE)
  content   String         @db.Text
  staffName String

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([createdAt])
  @@map("project_logs")
}

// ==============================================================
// RevenueReport（売上報告）
// ==============================================================

/// 月次売上報告。MANAGER 以上が自拠点のデータのみ登録・閲覧できる。
/// amount は税抜金額。targetMonth は計上月の月初日（YYYY-MM-01）で保存。
model RevenueReport {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(15, 0) // 売上金額（税抜）
  targetMonth DateTime // 計上月（月初日 YYYY-MM-01 で保存）
  memo        String?  @db.Text // 備考

  // ---- プロジェクト名（自由記述）------------------------------
  projectName String? // 関連プロジェクト名（自由入力）

  // ---- 作成者（データ保護の軸）--------------------------------
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  // ---- マルチテナント（必須）-----------------------------------
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId])
  @@index([targetMonth])
  @@index([createdById])
  @@map("revenue_reports")
}

// ==============================================================
// InvoiceRequest（請求依頼）
// ==============================================================

/// 本部へ提出する請求依頼。
/// 作成者本人と ADMIN（本部）のみが閲覧・操作できる。
model InvoiceRequest {
  id               String               @id @default(cuid())

  // ── 請求情報
  subject          String               // 件名
  contactName      String?              // 請求先担当者名
  contactEmail     String               // 請求先担当者メールアドレス（必須）
  billingDate      DateTime             // 請求日
  dueDate          DateTime?            // 支払期限
  details          String?              @db.Text // 内訳

  // ── 金額（10%税計算結果も保存）
  amountExclTax    Decimal              @db.Decimal(15, 0) // 税抜金額
  taxAmount        Decimal              @db.Decimal(15, 0) // 消費税額（10%）
  amountInclTax    Decimal              @db.Decimal(15, 0) // 税込金額

  // ── 検収・添付
  inspectionStatus String?              // 検収状況
  fileUrl          String?              // 請求書PDF URL
  notes            String?              @db.Text // 備考

  // ── ステータス
  status           InvoiceRequestStatus @default(DRAFT)

  // ── プロジェクト紐付け（任意）
  projectId        String?
  project          Project?             @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // ── 請求先顧客（CustomerテーブルのFK）
  customerId       String?
  customer         Customer?            @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // ── 作成者（データ保護の主軸）
  createdById      String
  createdBy        User                 @relation(fields: [createdById], references: [id])
  creatorEmail     String               // 通知用（非正規化）

  // ── マルチテナント
  branchId         String
  branch           Branch               @relation(fields: [branchId], references: [id])

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([branchId])
  @@index([createdById])
  @@index([status])
  @@index([projectId])
  @@index([customerId])
  // 複合インデックス: 自分の依頼を最新順で取得（一覧の主要クエリ）
  @@index([createdById, createdAt(sort: Desc)])
  @@map("invoice_requests")
}

// ==============================================================
// EstimationTemplate（標準単価マスタ）
// ==============================================================

/// 社内の標準単価マスタ。見積作成時のオートコンプリート元データ。
/// スタッフ向けに原価目安（costPrice）を保持するが、PDF には出力しない。
model EstimationTemplate {
  id        String   @id @default(cuid())
  category  String   // カテゴリ（例: 企画・進行）
  name      String   // 品目・サービス名
  unitPrice Decimal  @db.Decimal(15, 0) // 標準単価（税抜）
  unit      String   // 単位（例: 日、式）
  spec      String?  @db.Text // 仕様・提供範囲
  costPrice Decimal? @db.Decimal(15, 0) // 原価目安（スタッフ内部用・PDF非出力）
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("estimation_templates")
}

// ==============================================================
// Estimation（見積書）
// ==============================================================

/// 顧客向けの見積書。複数の EstimationItem を持つ。
model Estimation {
  id           String           @id @default(cuid())
  title        String           // 見積タイトル
  status       EstimationStatus @default(DRAFT)
  estimateDate DateTime         @default(now()) // 見積日
  validUntil   DateTime?        // 有効期限
  notes        String?          @db.Text // 備考
  staffName    String?          // 担当者名

  // ---- 顧客との紐づき（任意）------------------------------------
  customerId   String?
  customer     Customer?        @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // ---- プロジェクトとの紐づき（任意）----------------------------
  projectId    String?
  project      Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // ---- 出精値引き（内部用・PDF非出力）--------------------------
  discountAmount     Decimal?  @db.Decimal(15, 0) // 値引き額（税抜・正の数で入力し合計からマイナス）
  discountReason     String?   // BUDGET_FIRST | EXISTING | INVESTMENT | OTHER
  discountReasonNote String?   // 「その他」の場合の自由記述

  // ---- マルチテナント（必須）------------------------------------
  branchId     String
  branch       Branch           @relation(fields: [branchId], references: [id])

  items        EstimationItem[]

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([branchId])
  @@index([customerId])
  @@index([status])
  @@map("estimations")
}

// ==============================================================
// EstimationItem（見積明細）
// ==============================================================

/// 見積書の各行明細。マスタから補完されるが独立して編集可能。
model EstimationItem {
  id           String     @id @default(cuid())
  name         String     // 品目名
  spec         String?    @db.Text // 仕様・備考
  quantity     Int        @default(1) // 数量
  unit         String?    // 単位
  unitPrice    Decimal    @db.Decimal(15, 0) // 単価
  amount       Decimal    @db.Decimal(15, 0) // 金額（数量 × 単価）
  costPrice    Decimal?   @db.Decimal(15, 0) // 原価目安（内部用・PDF非出力）
  sortOrder    Int        @default(0)
  templateId   String?    // 参照元マスタ ID（任意）

  estimationId String
  estimation   Estimation @relation(fields: [estimationId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([estimationId])
  @@map("estimation_items")
}

// ==============================================================
// WikiArticle（社内Wiki記事）
// ==============================================================

/// 社内Wikiの記事。Markdownで記述・表示される。
model WikiArticle {
  id         String   @id @default(cuid())
  title      String
  body       String   @db.Text
  authorName String
  branchId   String
  branch     Branch   @relation(fields: [branchId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([branchId])
  @@map("wiki_articles")
}

// ==============================================================
// GroupCollaborationRequest（グループ連携依頼）
// ==============================================================

/// グループ内拠点間の連携依頼。撮影支援・機材手配・知見共有などを管理する。
model GroupCollaborationRequest {
  id              String                   @id @default(cuid())
  projectId       String?
  project         Project?                 @relation(fields: [projectId], references: [id], onDelete: SetNull)
  counterpartName String                   // 連携先代表（相手）
  requestType     CollaborationRequestType
  budget          String?                  // 希望予算（自由入力）
  description     String                   @db.Text // 依頼内容・条件
  desiredDate     DateTime?                // 希望納期・実施日
  attachmentUrl   String?                  // 添付ファイル URL
  status          CollaborationStatus      @default(PENDING)
  replyNote       String?                  @db.Text // やり取り・回答
  branchId        String?
  branch          Branch?                  @relation(fields: [branchId], references: [id])
  createdById     String?
  createdBy       User?                    @relation(fields: [createdById], references: [id])
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  @@index([branchId])
  @@index([createdById])
  @@index([status])
  @@index([projectId])
  // 複合インデックス: 拠点別 + 最新順（一覧取得の主要クエリ）
  @@index([branchId, createdAt(sort: Desc)])
  @@map("group_collaboration_requests")
}

// ==============================================================
// MediaRequest（媒体依頼）
// ==============================================================

/// 媒体広告の掲載依頼。MANAGER以上が申請・管理できる。
model MediaRequest {
  id            String             @id @default(cuid())
  mediaType     MediaType
  mediaName     String             // 媒体名（自由入力）
  customerId    String?
  customer      Customer?          @relation(fields: [customerId], references: [id], onDelete: SetNull)
  startDate     DateTime?          // 掲載開始日
  endDate       DateTime?          // 掲載終了日
  budget        String?            // 費用・予算（自由入力）
  description   String?            @db.Text
  attachmentUrl String?
  status        MediaRequestStatus @default(PENDING)
  replyNote     String?            @db.Text
  branchId      String?
  branch        Branch?            @relation(fields: [branchId], references: [id])
  createdById   String?
  createdBy     User?              @relation(fields: [createdById], references: [id])
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([branchId])
  @@index([createdById])
  @@index([status])
  @@index([branchId, createdAt(sort: Desc)])
  @@map("media_requests")
}

// ==============================================================
// AdvertiserReview（TVer広告主 業態考査申請）
// ==============================================================

/// TVer広告を出稿する広告主の業態考査申請。
/// 申請者が提出 → 管理者が APPROVED/REJECTED に更新。
/// APPROVED になった広告主のみ、次フェーズの TVer配信申請で選択可能。
model AdvertiserReview {
  id                   String                 @id @default(cuid())

  // ── 広告主情報
  name                 String                 // 広告主様名（必須）
  websiteUrl           String                 // 企業ページ URL（必須）
  corporateNumber      String?                @db.VarChar(13) // 法人番号（13桁）
  hasNoCorporateNumber Boolean                @default(false) // 法人番号なしフラグ
  productUrl           String                 // 商材サイト URL（必須）
  desiredStartDate     DateTime?              // 広告展開希望日
  remarks              String?                @db.Text // 備考

  // ── 考査ステータス
  status               AdvertiserReviewStatus @default(PENDING)
  reviewNote           String?                @db.Text // 審査コメント（管理者記入）
  reviewedAt           DateTime?              // 承認/否決日時
  reviewedById         String?
  reviewedBy           User?                  @relation("ReviewedAdvertiserReview", fields: [reviewedById], references: [id])

  // ── 申請者（担当者）
  createdById          String
  createdBy            User                   @relation("CreatedAdvertiserReview", fields: [createdById], references: [id])
  creatorEmail         String                 // 通知用（非正規化）

  // ── マルチテナント
  branchId             String
  branch               Branch                 @relation(fields: [branchId], references: [id])

  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  tverCampaigns        TverCampaign[]
  tverCreativeReviews  TverCreativeReview[]

  @@index([branchId])
  @@index([createdById])
  @@index([status])
  @@index([branchId, createdAt(sort: Desc)])
  @@map("advertiser_reviews")
}

// ==============================================================
// TverCampaign（TVer配信申請）
// ==============================================================

/// TVer広告の配信申請。
/// 業態考査で APPROVED になった広告主のみ選択可能。
model TverCampaign {
  id                 String                @id @default(cuid())

  // ── 広告主（業態考査承認済みのみ）
  advertiserId       String
  advertiser         AdvertiserReview      @relation(fields: [advertiserId], references: [id])

  // ── 案件基本情報
  campaignName       String                // キャンペーン名
  budget             Decimal               @db.Decimal(15, 0) // 広告予算（円・税抜）
  startDate          DateTime              // 配信開始日
  endDate            DateTime              // 配信終了日

  // ── 予算タイプ
  budgetType         TverCampaignBudgetType // 期間予算 / 月次予算

  // ── フリークエンシーキャップ（任意）
  freqCapUnit        TverFrequencyCapUnit? // カウント単位
  freqCapCount       Int?                  // 回数

  // ── コンパニオン AD
  companionMobile    TverCompanionMobile   @default(NONE)
  companionPc        TverCompanionPc       @default(NONE)

  // ── URL
  landingPageUrl     String?               // リンク先 LP URL

  // ── 申請ステータス
  status             TverCampaignStatus    @default(SUBMITTED)
  reviewNote         String?               @db.Text // 管理者コメント

  // ── 申請者（担当者）
  createdById        String
  createdBy          User                  @relation(fields: [createdById], references: [id])
  creatorEmail       String                // 通知用（非正規化）

  // ── マルチテナント
  branchId           String
  branch             Branch                @relation(fields: [branchId], references: [id])

  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  @@index([branchId])
  @@index([createdById])
  @@index([advertiserId])
  @@index([status])
  @@index([branchId, createdAt(sort: Desc)])
  @@map("tver_campaigns")
}

// ==============================================================
// TverCreativeReview（TVer クリエイティブ考査申請）
// ==============================================================

enum TverCreativeReviewStatus {
  SUBMITTED
  APPROVED
  REJECTED
}

/// TVer クリエイティブ（素材）の考査申請。
/// 業態考査で APPROVED になった広告主のみ選択可能。
model TverCreativeReview {
  id               String                   @id @default(cuid())

  // ── 広告主（業態考査承認済みのみ）
  advertiserId     String
  advertiser       AdvertiserReview         @relation(fields: [advertiserId], references: [id])

  // ── 案件情報
  projectName      String                   // プロジェクト名
  numberOfAssets   Int                      // 本数
  driveUrl         String                   // データ格納リンク
  remarks          String?                  @db.Text // 備考

  // ── 申請ステータス
  status           TverCreativeReviewStatus @default(SUBMITTED)

  // ── 申請者
  createdById      String
  createdBy        User                     @relation(fields: [createdById], references: [id])
  creatorEmail     String

  // ── マルチテナント
  branchId         String
  branch           Branch                   @relation(fields: [branchId], references: [id])

  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  @@index([branchId])
  @@index([createdById])
  @@index([advertiserId])
  @@index([status])
  @@map("tver_creative_reviews")
}
